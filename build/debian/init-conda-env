#! /bin/bash --login

# New Conda Environment Initialization Script
# ===========================================

printenv

err_exit() {
    echo "# !Error: $*"
    exit 1
}

[[ -z "${CONDA_ENV_FILE}" ]] && CONDA_ENV_FILE=/srv/conda/environment.yml
[[ -f "${CONDA_ENV_FILE}" ]] ||
    err_exit "file does not exist CONDA_ENV_FILE='$CONDA_ENV_FILE'"

set -e
echo "# => Installing new conda virtual environment from $CONDA_ENV_FILE ..."
conda activate base > /dev/null
CONDA_CMD=mamba
command -v $CONDA_CMD &>/dev/null || CONDA_CMD=conda
set +e
$CONDA_CMD env create --file "${CONDA_ENV_FILE}"
set -e
# set CONDA_ENV_USER based on .yml file
if [[ -z "${CONDA_ENV_USER}" ]] || [[ "${CONDA_ENV_USER}" = base ]]; then
    export CONDA_ENV_USER=$(awk '/name\:/ {print;}' "${CONDA_ENV_FILE}" |
        awk '{sub(/name\: /, "");} 1')
fi

echo "# => Switching to appropriate python environment and running command $* ..."
[[ -z "$CONDA_ENV_USER" ]] && CONDA_ENV_USER=base
conda activate $CONDA_ENV_USER > /dev/null

if [[ ${#@} -gt 0 ]]; then
    if [[ "$1" == "dev" ]]; then
        tail -f /dev/null
    fi
    set -eo pipefail
    exec -l "$@"
fi
