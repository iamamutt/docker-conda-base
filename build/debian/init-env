#! /bin/bash

# New User/Apt/Conda Env Initialization
# =====================================

set -e
init-apt-deps
init-new-user

_USER_INFO=$(cat /tmp/init-new-user.lastlog)
export _USER_NAME=$(echo $_USER_INFO | cut -d: -f1)
export _USER_GROUP=$(echo $_USER_INFO | cut -d: -f3)

if [[ -z "${_USER_NAME}" ]]; then
    echo "# ~Warning: user $_USER_NAME not found!"
    if [[ ${#@} -gt 0 ]]; then
        echo "running '$*' as '$(id -un)'"
        if [[ "$1" == "dev" ]]; then
            conda-run tail -f /dev/null
        else
            conda-run "$@"
        fi
    fi
    exit 0
fi

sudo --preserve-env --set-home --non-interactive \
    -u $_USER_NAME -g $_USER_GROUP bash -- <<EOF
init-conda-env
if [[ ${#@} -gt 0 ]]; then
    if [[ "$1" == "dev" ]]; then
        conda-run tail -f /dev/null
    else
        conda-run "$@"
    fi
fi
EOF
